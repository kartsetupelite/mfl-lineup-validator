<!DOCTYPE html>
<html>
<head>
<title>MFL Lineup Validator</title>
<style>
  body {
    font-family: Georgia, serif;
    background: #f5f5f5;
    padding: 20px;
  }
  
  #lineupReportContainer {
    text-align: center;
    padding: 10px;
  }
  
  #debugPanel {
    background: #000;
    color: #0f0;
    padding: 15px;
    margin: 20px 0;
    border-radius: 5px;
    max-height: 250px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 11px;
    text-align: left;
    white-space: pre-wrap;
    word-wrap: break-word;
    border: 2px solid #0f0;
  }
  
  .debug-line {
    margin: 2px 0;
    padding: 1px 0;
  }
  
  .debug-error { color: #ff6b6b; }
  .debug-success { color: #51cf66; }
  .debug-info { color: #74c0fc; }
  .debug-warn { color: #ffd43b; }
  
  .settings-box {
    background: #fff;
    border: 2px solid #333;
    padding: 15px;
    border-radius: 5px;
    margin: 20px 0;
    text-align: left;
    max-width: 600px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .settings-box label {
    display: block;
    margin: 10px 0;
    font-weight: bold;
  }
  
  .settings-box input {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    box-sizing: border-box;
  }
  
  button {
    padding: 10px 20px;
    margin: 5px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
  
  #clearDebugBtn {
    background: #ff6b6b;
    color: white;
  }
  
  select {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #aaa;
    font-size: 14px;
    margin: 5px;
  }
  
  .lr-tile {
    width: 170px;
    text-align: center;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 12px;
    background: #fff;
    display: inline-block;
    margin: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .lr-team-name {
    font-size: 12px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .lr-btn {
    width: 100%;
    padding: 8px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    font-size: 13px;
  }
  
  .lr-btn-invalid { background: #d9534f; }
  .lr-btn-valid { background: #5cb85c; }
  
  .lr-error {
    background: #f8d7da;
    color: #721c24;
    padding: 4px;
    margin-bottom: 4px;
    border-radius: 4px;
    font-size: 12px;
    text-align: left;
  }
  
  .lr-ok {
    color: #28a745;
    font-weight: bold;
    font-size: 12px;
  }
  
  .lr-details {
    display: none;
    margin-top: 8px;
  }
  
  #lr-counter {
    margin-bottom: 15px;
    font-weight: bold;
    font-size: 14px;
  }
  
  #lr-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
  }
  
  .loading {
    font-size: 16px;
    color: #666;
    padding: 20px;
  }
  
  .info-box {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    color: #0c5460;
    padding: 12px;
    border-radius: 4px;
    margin: 15px 0;
  }
</style>
</head>
<body>

<div id="lineupReportContainer">
  <h1>MFL Lineup Validator</h1>
  
  <div class="info-box">
    ✓ Validates MFL fantasy football lineups
  </div>
  
  <div class="settings-box">
    <h3>Configuration</h3>
    <label>League ID:
      <input type="text" id="leagueInput" value="17011">
    </label>
    <label>Year:
      <input type="text" id="yearInput" value="2026">
    </label>
    <label>Server:
      <input type="text" id="serverInput" value="www48">
    </label>
    <button id="clearDebugBtn">Clear Debug Log</button>
  </div>
  
  <div id="debugPanel">
    <div class="debug-line debug-info">Debug console ready...</div>
  </div>
  
  <div style="margin: 20px 0;">
    <label>Week:
      <select id="lr-weekSelector"></select>
    </label>
    <button id="runReportBtn" style="background: #2196F3; color: white; padding: 10px 30px; font-size: 16px;">Run Report</button>
  </div>
  
  <div id="lr-counter"></div>
  <div id="lr-grid"></div>
</div>

<script>
var LR_leagueID  = "17011";
var LR_year      = "2026";
var LR_server    = "www48";

var LR_required  = { QB:1, RB:2, WR:3, TE:1, PK:1, DT:1, DE:2, LB:2, CB:3, S:2 };
var LR_maxIDP    = { DT:3, DE:5, LB:5, CB:4, S:3 };
var LR_offPos    = ["QB","RB","WR","TE","PK"];
var LR_defPos    = ["DT","DE","LB","CB","S"];

var LR_franchises  = [];
var LR_results     = [];
var LR_doneCount   = 0;

var debugPanel = document.getElementById("debugPanel");
var debugCount = 0;

function LR_debug(message, type) {
  type = type || "info";
  debugCount++;
  
  var timestamp = new Date().toLocaleTimeString();
  var classMap = {
    "error": "debug-error",
    "success": "debug-success",
    "info": "debug-info",
    "warn": "debug-warn"
  };
  
  var className = classMap[type] || "debug-info";
  var line = document.createElement("div");
  line.className = "debug-line " + className;
  line.textContent = "[" + timestamp + "] " + message;
  
  debugPanel.appendChild(line);
  debugPanel.scrollTop = debugPanel.scrollHeight;
}

document.getElementById("clearDebugBtn").addEventListener("click", function() {
  debugPanel.innerHTML = '<div class="debug-line debug-info">Debug log cleared</div>';
  debugCount = 0;
});

var LR_weekSelector = document.getElementById("lr-weekSelector");
var LR_counterDiv   = document.getElementById("lr-counter");
var LR_grid         = document.getElementById("lr-grid");

for (var lri = 1; lri <= 18; lri++) {
  var lrOpt = document.createElement("option");
  lrOpt.value = lri;
  lrOpt.textContent = "Week " + lri;
  LR_weekSelector.appendChild(lrOpt);
}

document.getElementById("runReportBtn").addEventListener("click", function() {
  LR_leagueID = document.getElementById("leagueInput").value;
  LR_year = document.getElementById("yearInput").value;
  LR_server = document.getElementById("serverInput").value;
  LR_runReport(parseInt(LR_weekSelector.value, 10));
});

function LR_apiURL(params) {
  return "https://" + LR_server + ".myfantasyleague.com/" + LR_year + "/export?" + params + "&JSON=1";
}

function LR_fetchJSON(params, callback) {
  var url = LR_apiURL(params);
  
  fetch(url)
    .then(function(response) {
      return response.text();
    })
    .then(function(text) {
      try {
        var data = JSON.parse(text);
        callback(data);
      } catch(e) {
        LR_debug("Parse error: " + e.message, "error");
        callback(null);
      }
    })
    .catch(function(err) {
      LR_debug("Fetch error: " + err.message, "error");
      callback(null);
    });
}

function LR_loadLeague() {
  LR_debug("Loading league " + LR_leagueID + "...", "info");
  
  LR_fetchJSON("TYPE=league&L=" + LR_leagueID, function(data) {
    
    if (!data || !data.league) {
      LR_debug("Failed to load league", "error");
      LR_grid.innerHTML = '<div class="loading">Error loading league</div>';
      return;
    }

    LR_debug("League loaded successfully", "success");

    var currentWeek = parseInt(data.league.currentWeek || "1", 10);
    if (isNaN(currentWeek) || currentWeek < 1) currentWeek = 1;
    LR_debug("Current week: " + currentWeek, "info");

    var franchisesObj = data.league.franchises;
    var teams = [];
    
    if (franchisesObj && franchisesObj.franchise) {
      teams = franchisesObj.franchise;
      if (!Array.isArray(teams)) {
        teams = [teams];
      }
    }

    LR_debug("Found " + teams.length + " franchises", "success");

    LR_franchises = teams.map(function(t) {
      return { 
        id: t.id, 
        name: t.name || ("Team " + t.id), 
        icon: t.icon || "" 
      };
    });

    LR_weekSelector.value = currentWeek;
  });
}

function LR_fetchStarters(franchiseID, week, callback) {
  
  LR_fetchJSON("TYPE=lineup&L=" + LR_leagueID + "&F=" + franchiseID + "&W=" + week, function(data) {

    if (!data || !data.lineup) {
      callback([]);
      return;
    }

    var players = data.lineup.player;
    
    if (!players) {
      callback([]);
      return;
    }
    
    if (!Array.isArray(players)) {
      players = [players];
    }

    var starters = [];
    
    players.forEach(function(p) {
      if (p.status === "starter") {
        starters.push(p.position);
      }
    });

    callback(starters);
  });
}

function LR_validate(starters) {
  var counts  = {};
  var offense = 0;
  var defense = 0;
  var errors  = [];

  starters.forEach(function(pos) {
    counts[pos] = (counts[pos] || 0) + 1;
    if (LR_offPos.indexOf(pos) !== -1) offense++;
    if (LR_defPos.indexOf(pos) !== -1) defense++;
  });

  for (var pos in LR_required) {
    if ((counts[pos] || 0) < LR_required[pos])
      errors.push("Missing " + pos + " (" + (counts[pos]||0) + "/" + LR_required[pos] + ")");
  }
  for (var pos2 in LR_maxIDP) {
    if ((counts[pos2] || 0) > LR_maxIDP[pos2])
      errors.push("Too many " + pos2 + " (" + counts[pos2] + "/" + LR_maxIDP[pos2] + " max)");
  }
  if (offense !== 9)          errors.push("Offense total " + offense + "/9");
  if (defense !== 13)         errors.push("Defense total " + defense + "/13");
  if (starters.length !== 22) errors.push("Total starters " + starters.length + "/22");

  return errors;
}

function LR_toggle(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.style.display = el.style.display === "none" ? "block" : "none";
}

function LR_renderGrid(week) {
  LR_grid.innerHTML = "";
  var valid = 0, invalid = 0;

  LR_results.sort(function(a, b) {
    if (a.errors.length > 0 && b.errors.length === 0) return -1;
    if (a.errors.length === 0 && b.errors.length > 0) return 1;
    return a.team.name.localeCompare(b.team.name);
  });

  LR_results.forEach(function(r) {
    var isInvalid = r.errors.length > 0;
    if (isInvalid) invalid++; else valid++;

    var tileID = "lr_details_" + r.team.id;
    var tile   = document.createElement("div");
    tile.className = "lr-tile";

    var iconHTML = r.team.icon
      ? '<img src="' + r.team.icon + '" width="80" style="margin-bottom:6px;display:block;margin-left:auto;margin-right:auto;">'
      : '<div style="width:80px;height:80px;background:#eee;border-radius:6px;margin:0 auto 6px;line-height:80px;font-size:11px;color:#999;">No Icon</div>';

    var errorsHTML = isInvalid
      ? r.errors.map(function(e){ return '<div class="lr-error">' + e + '</div>'; }).join("")
      : '<div class="lr-ok">✓ Valid</div>';

    tile.innerHTML =
      iconHTML +
      '<div class="lr-team-name" title="' + r.team.name + '">' + r.team.name + '</div>' +
      '<button class="lr-btn ' + (isInvalid ? 'lr-btn-invalid' : 'lr-btn-valid') +
        '" onclick="LR_toggle(\'' + tileID + '\')">' +
        (isInvalid ? '✗ INVALID' : '✓ VALID') +
      '</button>' +
      '<div id="' + tileID + '" class="lr-details">' + errorsHTML + '</div>';

    LR_grid.appendChild(tile);
  });

  LR_counterDiv.innerHTML =
    "Week " + week + "  |  " +
    "Total: " + LR_franchises.length +
    "  |  <span style='color:#d9534f;'>Invalid: " + invalid + "</span>" +
    "  |  <span style='color:#5cb85c;'>Valid: " + valid + "</span>";
}

function LR_runReport(week) {
  LR_grid.innerHTML = '<div class="loading">Loading lineups for week ' + week + '...</div>';
  LR_counterDiv.innerHTML = "";
  LR_results   = [];
  LR_doneCount = 0;

  LR_debug("Starting report for week " + week, "warn");

  if (LR_franchises.length === 0) {
    LR_debug("Franchises not loaded, loading league...", "warn");
    LR_loadLeague();
    setTimeout(function() {
      LR_runReport(week);
    }, 2000);
    return;
  }

  LR_debug("Fetching lineups for " + LR_franchises.length + " teams...", "info");

  LR_franchises.forEach(function(team, idx) {
    var delayMs = idx * 1000;
    
    setTimeout(function() {
      LR_fetchStarters(team.id, week, function(starters) {
        var errors = LR_validate(starters);
        LR_results.push({ team: team, errors: errors });
        LR_doneCount++;
        
        var status = errors.length > 0 ? "INVALID" : "VALID";
        LR_debug(team.name + ": " + status + " (" + LR_doneCount + "/" + LR_franchises.length + ")", errors.length > 0 ? "warn" : "success");
        
        if (LR_doneCount === LR_franchises.length) {
          LR_renderGrid(week);
        }
      });
    }, delayMs);
  });
}

LR_debug("Script ready - Loading league...", "success");
LR_loadLeague();
</script>

</body>
</html>